<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Message Log</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent body scrolling */
        }
        /* Custom scrollbar style for dark theme */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
    </style>
    <!-- Lucide Icons Library -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-900 text-white">

    <div id="app" class="flex h-screen">
        <!-- Main Application Layout -->
        <div id="main-layout" class="w-full h-full flex">
            
            <!-- Sidebar -->
            <aside id="sidebar" class="flex-col w-64 bg-gray-900 border-r border-gray-700 flex-shrink-0 transition-transform duration-300 ease-in-out fixed md:static h-full z-20">
                <!-- User Info Header -->
                <div class="p-4 border-b border-gray-700">
                    <div class="flex items-center mb-3">
                        <div class="bg-green-500 p-2 rounded-full mr-3 text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <div class="flex flex-col">
                            <span id="user-name" class="font-bold text-lg">Local User</span>
                            <span id="user-phone" class="text-sm text-gray-400 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone mr-1"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-5.6-5.6A19.79 19.79 0 0 1 2 16.18v-3a2 2 0 0 1 2-2h3.41A23.11 23.11 0 0 1 12 11.29V7a2 2 0 0 1 2-2h3.41A23.11 23.11 0 0 1 22 12.18v3.74"/></svg> 0000000000
                            </span>
                        </div>
                    </div>
                    <button id="add-contact-btn" class="w-full flex items-center justify-center py-2 px-3 text-sm font-medium bg-green-600 rounded-lg hover:bg-green-500 transition-colors shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Add Contact
                    </button>
                </div>
                
                <!-- Contact List -->
                <nav class="flex-grow overflow-y-auto space-y-1 p-3 text-sm custom-scrollbar">
                    <h3 class="text-xs uppercase font-semibold text-gray-500 px-3 py-2">Local Contacts (<span id="contact-count">0</span>)</h3>
                    <div id="contact-list">
                        <!-- Contacts will be rendered here -->
                    </div>
                </nav>

                <!-- Footer/Logout -->
                <div class="border-t border-gray-700 p-3">
                    <p class="text-xs text-red-500 text-center font-bold">
                        LOCAL STORAGE ONLY
                    </p>
                    <p class="text-xs text-gray-600 mt-1 text-center italic">
                        Data is saved only in your browser.
                    </p>
                </div>
            </aside>

            <!-- Main Chat Content -->
            <div id="chat-content" class="flex-grow flex flex-col w-full md:w-[calc(100%-16rem)]">
                <!-- Chat Header -->
                <header id="chat-header" class="flex items-center p-4 bg-gray-900 border-b border-gray-700 hidden">
                    <button id="mobile-menu-btn" class="md:hidden text-gray-400 hover:text-white mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                    </button>
                    <div class="flex flex-col">
                        <h2 id="contact-name-header" class="text-xl font-bold text-white"></h2>
                        <p id="contact-phone-header" class="text-sm text-gray-400"></p>
                    </div>
                </header>
                
                <!-- Welcome Screen -->
                <div id="welcome-screen" class="flex flex-col items-center justify-center flex-grow bg-gray-800 p-4 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-archive-restore text-red-500 mb-6"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M12 18v-6"/><path d="m16 16-4-4-4 4"/><path d="M21 8H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z"/></svg>
                    <h2 class="text-3xl font-bold mb-2 text-white">Local Message Log</h2>
                    <p class="text-red-400 max-w-sm font-semibold">
                        NOTE: This version uses local storage. Messages are NOT sent to a network and are only visible in this browser.
                    </p>
                    <p class="text-gray-400 max-w-sm mt-3">
                        Select a contact from the sidebar to view their local chat history, or press the <strong>Add Contact</strong> button to create a new log.
                    </p>
                </div>

                <!-- Message Area -->
                <div id="message-area" class="hidden flex-grow overflow-y-auto p-4 space-y-4 bg-gray-800 custom-scrollbar">
                    <!-- Messages will be rendered here -->
                </div>

                <!-- Input Bar -->
                <div id="input-footer" class="hidden p-4 bg-gray-900 border-t border-gray-700">
                    <div class="flex items-center bg-gray-800 rounded-xl p-2 border border-gray-700">
                        <input
                            type="text"
                            id="message-input"
                            placeholder="Type a message to save..."
                            class="flex-grow p-2 bg-transparent text-white placeholder-gray-400 focus:outline-none"
                            disabled
                        />
                        <button
                            id="send-message-btn"
                            class="p-3 rounded-lg ml-2 bg-gray-700 text-gray-500 cursor-not-allowed transition-colors"
                            disabled
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Contact Modal -->
            <div id="contact-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus mr-2 text-green-400"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Add New Contact Log
                        </h2>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>
                    <form id="add-contact-form" class="space-y-4">
                        <input
                            type="text"
                            id="target-phone-input"
                            placeholder="Target Phone Number (10 digits for simulation)"
                            class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            required
                            minlength="10"
                            maxlength="10"
                        />
                        <input
                            type="text"
                            id="contact-name-input"
                            placeholder="Contact Name (e.g., Jane Doe)"
                            class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            required
                        />
                        <button
                            type="submit"
                            id="submit-contact-btn"
                            class="w-full p-3 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-500 transition-colors flex items-center justify-center"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8h-6v8"/><path d="M8 3V1"/></svg> Save Contact
                        </button>
                    </form>
                    <p id="modal-message" class="mt-4 text-center text-sm font-medium hidden"></p>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- Local Data Storage Keys ---
        const USER_PHONE_KEY = 'local-log-user-phone';
        const USER_NAME_KEY = 'local-log-user-name';
        const CONTACTS_KEY = 'local-log-contacts';
        const MESSAGES_KEY = 'local-log-messages'; // Stores all chat logs as an object { chatId: messagesArray }

        // --- State Variables ---
        let userPhone = null;
        let userName = 'Local User';
        let contacts = [];
        let messagesLog = {}; // Master object holding all chat histories
        let selectedContact = null;
        
        // --- Utility Functions ---

        const generatePhoneNumber = () => {
            // Generate a fake 10-digit number for simulation
            return '000' + Array(7).fill(0).map(() => Math.floor(Math.random() * 10)).join('');
        };

        const getChatId = (phone1, phone2) => {
            // Create a consistent ID regardless of phone order
            const sorted = [phone1, phone2].sort();
            return `${sorted[0]}_${sorted[1]}`;
        };
        
        const loadLocalData = () => {
            // Load user profile
            userPhone = localStorage.getItem(USER_PHONE_KEY) || generatePhoneNumber();
            userName = localStorage.getItem(USER_NAME_KEY) || `User-${userPhone.substring(6)}`;
            
            // Persist the generated/loaded profile
            localStorage.setItem(USER_PHONE_KEY, userPhone);
            localStorage.setItem(USER_NAME_KEY, userName);
            
            // Load contacts
            const storedContacts = localStorage.getItem(CONTACTS_KEY);
            contacts = storedContacts ? JSON.parse(storedContacts) : [];

            // Load all messages
            const storedMessagesLog = localStorage.getItem(MESSAGES_KEY);
            messagesLog = storedMessagesLog ? JSON.parse(storedMessagesLog) : {};
        };

        const saveLocalData = () => {
            localStorage.setItem(CONTACTS_KEY, JSON.stringify(contacts));
            localStorage.setItem(MESSAGES_KEY, JSON.stringify(messagesLog));
        };

        // --- Rendering and DOM Manipulation ---

        const renderUserHeader = () => {
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-phone').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone mr-1"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-5.6-5.6A19.79 19.79 0 0 1 2 16.18v-3a2 2 0 0 1 2-2h3.41A23.11 23.11 0 0 1 12 11.29V7a2 2 0 0 1 2-2h3.41A23.11 23.11 0 0 1 22 12.18v3.74"/></svg> ${userPhone}`;
        };

        const renderContacts = () => {
            const contactListEl = document.getElementById('contact-list');
            contactListEl.innerHTML = '';
            document.getElementById('contact-count').textContent = contacts.length;
            
            if (contacts.length === 0) {
                contactListEl.innerHTML = '<p class="text-gray-500 text-center p-4 italic">No local logs yet. Add one!</p>';
                return;
            }

            contacts.forEach(contact => {
                const isSelected = selectedContact && selectedContact.id === contact.id;
                const contactEl = document.createElement('div');
                contactEl.id = `contact-${contact.id}`;
                contactEl.className = `flex items-center px-3 py-3 rounded-lg cursor-pointer transition-colors ${
                    isSelected ? 'bg-gray-700 text-white border-l-4 border-green-500' : 'hover:bg-gray-800 text-gray-300'
                }`;
                contactEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square mr-3 flex-shrink-0"><path d="m21 14.16-5.26-2.11a2 2 0 0 0-1.81-.07L7.4 20.84a2 2 0 0 0 .54 2.21 2 2 0 0 0 2.21-.54L15.93 7.8a2 2 0 0 0-.07-1.81l-2.11-5.26a2 2 0 0 0-2.31-1.35 2 2 0 0 0-1.35 2.31z"/></svg>
                    <div class="flex flex-col overflow-hidden">
                        <span class="font-medium truncate text-white">${contact.name}</span>
                        <span class="text-xs text-gray-500">${contact.targetPhoneNumber}</span>
                    </div>
                `;
                contactEl.onclick = () => selectContact(contact);
                contactListEl.appendChild(contactEl);
            });
        };

        const renderMessages = (messages) => {
            const messageAreaEl = document.getElementById('message-area');
            messageAreaEl.innerHTML = '';
            
            messages.forEach(msg => {
                const isUser = msg.senderPhone === userPhone;
                const msgEl = document.createElement('div');
                msgEl.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Sending...';

                msgEl.innerHTML = `
                    <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-md ${
                        isUser
                            ? 'bg-green-600 text-white rounded-br-none'
                            : 'bg-gray-700 text-white rounded-tl-none'
                    }">
                        <p class="text-xs font-semibold mb-1 text-gray-300">
                            ${isUser ? 'You' : selectedContact.name}
                        </p>
                        <p>${msg.text}</p>
                        <p class="text-right text-xs mt-1 text-gray-400">
                            ${time}
                        </p>
                    </div>
                `;
                messageAreaEl.appendChild(msgEl);
            });
            messageAreaEl.scrollTop = messageAreaEl.scrollHeight;
        };

        const updateChatView = (contact) => {
            const welcomeScreen = document.getElementById('welcome-screen');
            const chatHeader = document.getElementById('chat-header');
            const messageArea = document.getElementById('message-area');
            const inputFooter = document.getElementById('input-footer');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-message-btn');

            if (contact) {
                welcomeScreen.classList.add('hidden');
                chatHeader.classList.remove('hidden');
                messageArea.classList.remove('hidden');
                inputFooter.classList.remove('hidden');
                
                document.getElementById('contact-name-header').textContent = contact.name;
                document.getElementById('contact-phone-header').textContent = contact.targetPhoneNumber;
                
                messageInput.disabled = false;
                sendButton.disabled = !messageInput.value.trim();
                messageInput.focus();
            } else {
                welcomeScreen.classList.remove('hidden');
                chatHeader.classList.add('hidden');
                messageArea.classList.add('hidden');
                inputFooter.classList.add('hidden');
            }
        };

        // --- Core Application Logic ---

        const selectContact = (contact, shouldToggleSidebar = true) => {
            selectedContact = contact;
            updateChatView(contact);
            renderContacts(); // Highlight the selected contact

            if (window.innerWidth < 768 && shouldToggleSidebar) {
                document.getElementById('sidebar').classList.add('hidden');
            }
            
            const chatId = getChatId(userPhone, contact.targetPhoneNumber);
            const msgs = messagesLog[chatId] || [];
            
            renderMessages(msgs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)));
        };

        const handleSendMessage = () => {
            const inputEl = document.getElementById('message-input');
            const text = inputEl.value.trim();

            if (!text || !selectedContact || !userPhone) return;

            inputEl.value = ''; // Clear input immediately
            document.getElementById('send-message-btn').disabled = true; // Disable button

            const chatId = getChatId(userPhone, selectedContact.targetPhoneNumber);

            const messageData = {
                senderPhone: userPhone,
                text: text,
                timestamp: new Date().toISOString(),
            };
            
            // Add message to the log
            if (!messagesLog[chatId]) {
                messagesLog[chatId] = [];
            }
            messagesLog[chatId].push(messageData);

            // Save to local storage
            saveLocalData();
            
            // Re-render chat view
            const msgs = messagesLog[chatId] || [];
            renderMessages(msgs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)));
        };
        
        const handleAddContact = (targetPhone, contactName, modal) => {
            const messageEl = document.getElementById('modal-message');
            const submitBtn = document.getElementById('submit-contact-btn');
            
            submitBtn.innerHTML = 'Saving...';
            submitBtn.disabled = true;
            messageEl.classList.add('hidden');

            if (targetPhone === userPhone) {
                messageEl.textContent = 'Cannot add your own number.';
                messageEl.classList.remove('hidden');
                messageEl.classList.add('text-red-400');
                submitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8h-6v8"/><path d="M8 3V1"/></svg> Save Contact`;
                submitBtn.disabled = false;
                return;
            }

            // Check if contact already exists
            const exists = contacts.some(c => c.targetPhoneNumber === targetPhone);
            if (exists) {
                messageEl.textContent = 'Contact with this number already exists.';
                messageEl.classList.remove('hidden');
                messageEl.classList.add('text-red-400');
                submitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8h-6v8"/><path d="M8 3V1"/></svg> Save Contact`;
                submitBtn.disabled = false;
                return;
            }
            
            try {
                const newContact = {
                    id: crypto.randomUUID(), // Unique ID for contact tracking
                    targetPhoneNumber: targetPhone,
                    name: contactName,
                    addedAt: new Date().toISOString(),
                };
                
                contacts.push(newContact);
                saveLocalData();

                messageEl.textContent = 'Contact log created successfully!';
                messageEl.classList.remove('hidden');
                messageEl.classList.remove('text-red-400');
                messageEl.classList.add('text-green-400');
                
                renderContacts();

                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('target-phone-input').value = '';
                    document.getElementById('contact-name-input').value = '';
                    messageEl.classList.add('hidden');
                }, 1500);

            } catch (error) {
                console.error("Error saving contact:", error);
                messageEl.textContent = 'Error saving contact.';
                messageEl.classList.remove('hidden');
                messageEl.classList.add('text-red-400');
            } finally {
                submitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8h-6v8"/><path d="M8 3V1"/></svg> Save Contact`;
                if (!messageEl.textContent.includes('successfully')) {
                    submitBtn.disabled = false;
                }
            }
        };

        const initApp = () => {
            loadLocalData();
            renderUserHeader();
            renderContacts();
        };
        
        // --- Event Listeners Setup ---

        const setupEventListeners = () => {
            const sidebar = document.getElementById('sidebar');
            const modal = document.getElementById('contact-modal');
            const messageInput = document.getElementById('message-input');

            // Modal Controls
            document.getElementById('add-contact-btn').onclick = () => modal.classList.remove('hidden');
            document.getElementById('close-modal-btn').onclick = () => modal.classList.add('hidden');
            
            // Add Contact Submission
            document.getElementById('add-contact-form').onsubmit = (e) => {
                e.preventDefault();
                const targetPhone = document.getElementById('target-phone-input').value.replace(/[^0-9]/g, '');
                const contactName = document.getElementById('contact-name-input').value.trim();
                handleAddContact(targetPhone, contactName, modal);
            };

            // Send Message
            document.getElementById('send-message-btn').onclick = handleSendMessage;
            messageInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSendMessage();
                }
            };
            
            // Input Change for Send Button
            messageInput.oninput = () => {
                document.getElementById('send-message-btn').disabled = !messageInput.value.trim();
                document.getElementById('send-message-btn').classList.toggle('bg-green-600', messageInput.value.trim());
                document.getElementById('send-message-btn').classList.toggle('text-white', messageInput.value.trim());
                document.getElementById('send-message-btn').classList.toggle('bg-gray-700', !messageInput.value.trim());
                document.getElementById('send-message-btn').classList.toggle('text-gray-500', !messageInput.value.trim());
                document.getElementById('send-message-btn').classList.toggle('cursor-not-allowed', !messageInput.value.trim());
            };

            // Mobile Menu Toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            mobileMenuBtn.onclick = () => sidebar.classList.toggle('hidden');
            
            // Initial sidebar state for desktop
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('hidden');
            }
        };

        // Initialize Application
        window.onload = () => {
            setupEventListeners();
            initApp();
        };

    </script>
</body>
</html>
